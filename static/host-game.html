<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Host Game - Quiz Platform</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: url("/static/images/dash_bg.png") center/cover no-repeat;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 60px;
            width: 90%;
            max-width: 900px;
            display: flex;
            gap: 60px;
            align-items: center;
        }

        .left-section {
            flex: 1;
            text-align: center;
        }

        .quiz-illustration {
            width: 400px;
            height: 400px;
            background: url("/static/images/questionmarks.png") center/contain no-repeat;
            margin: 0 auto;
        }

        .right-section {
            flex: 1;
        }

        h1 {
            color: #1f2937;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 40px;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .join-code-display, .player-count-display {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1f2937;
        }

        .status-text {
            text-align: center;
            color: #6b7280;
            font-size: 1rem;
            margin-bottom: 20px;
        }

        .player-list {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            min-height: 100px;
            max-height: 150px;
            overflow-y: auto;
            margin-bottom: 30px;
        }

        .player-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            font-size: 16px;
            color: #374151;
        }

        .player-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            margin-right: 12px;
        }

        .generate-button {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            padding: 18px 40px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
            width: 100%;
            margin-bottom: 10px;
        }

        .generate-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(99, 102, 241, 0.4);
        }

        .generate-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .secondary-button {
            background: white;
            color: #6366f1;
            border: 2px solid #6366f1;
            padding: 16px 40px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 10px;
        }

        .secondary-button:hover {
            background: #6366f1;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
        }

        .notification {
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-weight: 500;
            display: none;
        }

        .notification.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .notification.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .notification.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* NEW: Auto-advance notification */
        .notification.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .loading-spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Game Control Interface */
        .game-controls {
            display: none;
        }

        .game-controls.active {
            display: block;
        }

        .question-progress {
            background: #f3f4f6;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .question-number {
            font-size: 1.2rem;
            font-weight: 600;
            color: #6366f1;
        }

        .question-timer {
            background: #fef3c7;
            color: #d97706;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .question-timer.warning {
            background: #fecaca;
            color: #dc2626;
            animation: pulse 1s infinite;
        }

        .current-question {
            background: #e0e7ff;
            border-left: 4px solid #6366f1;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .question-text {
            font-size: 1.3rem;
            color: #1f2937;
            font-weight: 500;
            margin-bottom: 15px;
        }

        .answer-options {
            display: grid;
            gap: 10px;
        }

        .answer-option {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .answer-label {
            background: #6366f1;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .correct-answer {
            border-color: #16a34a;
            background: #dcfce7;
        }

        .player-responses {
            background: #f9fafb;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .response-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .responses-count {
            font-weight: 600;
            color: #374151;
        }

        .avg-time {
            color: #6b7280;
            font-size: 0.9rem;
        }

        .next-question-btn {
            background: #16a34a;
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .next-question-btn:hover {
            background: #15803d;
            transform: translateY(-1px);
        }

        .next-question-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .end-game-btn {
            background: #dc2626;
            color: white;
            border: none;
            padding: 12px 32px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
        }

        .end-game-btn:hover {
            background: #b91c1c;
        }

        .mini-leaderboard {
            background: #f8fafc;
            border-radius: 12px;
            padding: 15px;
            margin-top: 20px;
        }

        .mini-leaderboard h4 {
            margin: 0 0 10px 0;
            color: #374151;
            font-size: 1rem;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 0.9rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .leaderboard-item:last-child {
            border-bottom: none;
        }

        /* NEW: Auto-advance indicator */
        .auto-advance-indicator {
            background: #fbbf24;
            color: #92400e;
            padding: 10px 16px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 600;
            text-align: center;
            display: none;
            animation: fadeInOut 3s ease-in-out;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            10%, 90% { opacity: 1; }
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                gap: 30px;
                padding: 30px;
            }

            .game-header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="left-section">
            <div class="quiz-illustration"></div>
        </div>

        <div class="right-section">
            <h1 id="quiz-title">Quiz Title</h1>

            <div class="game-header">
                <div class="join-code-display">Join Code: <span id="join-code">ABC123</span></div>
                <div class="player-count-display">Players: <span id="player-count">0</span></div>
            </div>

            <div id="notification" class="notification"></div>

            <!-- WAITING ROOM INTERFACE -->
            <div id="waiting-interface">
                <div class="status-text" id="status-text">
                    Waiting for Players...
                </div>

                <div class="player-list" id="player-list">
                    <div style="text-align: center; color: #6b7280;">No players connected yet</div>
                </div>

                <div id="waiting-controls">
                    <button class="generate-button" id="start-game-btn" onclick="startGame()">
                        <div class="loading-spinner" id="loadingSpinner"></div>
                        <span id="buttonText">Start Game (Need at least 1 player)</span>
                    </button>
                    <button class="secondary-button" onclick="refreshPlayers()">
                        Refresh Players
                    </button>
                    <button class="secondary-button" onclick="backToDashboard()">
                        Back to Dashboard
                    </button>
                </div>
            </div>

            <!-- GAME CONTROL INTERFACE -->
            <div class="game-controls" id="game-controls">
                <!-- NEW: Auto-advance indicator -->
                <div class="auto-advance-indicator" id="auto-advance-indicator">
                    ‚è∞ Question auto-advanced due to time expiry
                </div>

                <div class="question-progress">
                    <div class="progress-header">
                        <div class="question-number" id="question-number">Question 1 of 5</div>
                        <div class="question-timer" id="question-timer">20</div>
                    </div>
                </div>

                <div class="current-question">
                    <div class="question-text" id="current-question-text">
                        Loading question...
                    </div>
                    <div class="answer-options" id="current-answer-options">
                        <!-- Answers will be displayed here -->
                    </div>
                </div>

                <div class="player-responses">
                    <div class="response-summary">
                        <div class="responses-count" id="responses-count">0 / 1 players responded</div>
                        <div class="avg-time" id="avg-time">Time left: <span id="time-remaining">20s</span></div>
                    </div>
                </div>

                <div class="mini-leaderboard">
                    <h4>Current Standings</h4>
                    <div id="game-leaderboard">
                        <!-- Leaderboard will be shown here -->
                    </div>
                </div>

                <button class="next-question-btn" id="next-question-btn" onclick="nextQuestion()">
                    <span id="next-btn-text">Next Question</span>
                </button>

                <button class="end-game-btn" onclick="endGame()">
                    End Game
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let csrfToken = '';

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        class GameHostManager {
            constructor() {
                this.quizId = null;
                this.sessionId = null;
                this.gameStatus = 'waiting';
                this.players = [];
                this.refreshInterval = null;
                this.gameStateInterval = null;
                this.currentQuestionIndex = 0;
                this.totalQuestions = 5;
                this.currentQuestion = null;
                this.lastQuestionIndex = -1; // NEW: Track question changes

                this.init();
            }

            async init() {
                try {
                    console.log('üéÆ Starting host game initialization...');
                    await this.fetchCSRFToken();
                    await this.loadQuizFromURL();
                    await this.loadQuizDetails();
                    await this.createOrGetSession();
                    this.startPlayerRefresh();
                    console.log('‚úÖ Host game initialization completed successfully');
                } catch (error) {
                    console.error('‚ùå Initialization error:', error);
                    this.showNotification('Failed to initialize game. Please try again.', 'error');
                }
            }

            async fetchCSRFToken() {
                try {
                    const response = await fetch(`${API_BASE}/auth/csrf/`, {
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        csrfToken = data.csrfToken;
                        console.log('‚úÖ CSRF token fetched from API successfully');
                    } else {
                        throw new Error('API endpoint failed');
                    }
                } catch (error) {
                    console.log('‚ö†Ô∏è API CSRF fetch failed, trying cookie fallback:', error);
                    csrfToken = getCookie('csrftoken');
                    if (csrfToken) {
                        console.log('‚úÖ CSRF token found in cookie');
                    } else {
                        console.error('‚ùå No CSRF token available');
                    }
                }
            }

            loadQuizFromURL() {
                const urlParams = new URLSearchParams(window.location.search);
                this.quizId = urlParams.get('quiz_id') || localStorage.getItem('currentQuizId');

                console.log('üìù Quiz ID from URL/localStorage:', this.quizId);

                if (!this.quizId) {
                    throw new Error('No quiz ID provided');
                }
            }

            async loadQuizDetails() {
                try {
                    console.log('üìö Loading quiz details for ID:', this.quizId);
                    const response = await fetch(`${API_BASE}/quizzes/${this.quizId}/`, {
                        credentials: 'include'
                    });

                    if (!response.ok) {
                        throw new Error(`Failed to load quiz: ${response.status}`);
                    }

                    const quiz = await response.json();
                    console.log('üìö Quiz details loaded:', quiz);

                    this.displayQuizInfo(quiz);
                    this.totalQuestions = quiz.questions ? quiz.questions.length : 5;
                } catch (error) {
                    console.error('‚ùå Error loading quiz:', error);
                    throw error;
                }
            }

            displayQuizInfo(quiz) {
                document.getElementById('quiz-title').textContent = quiz.title;
                document.getElementById('join-code').textContent = quiz.join_code;
                console.log('üè∑Ô∏è Quiz info displayed:', { title: quiz.title, joinCode: quiz.join_code });
            }

            async createOrGetSession() {
                try {
                    console.log('üéØ Creating/getting session for quiz:', this.quizId);

                    if (!csrfToken) {
                        await this.fetchCSRFToken();
                    }

                    const response = await fetch(`${API_BASE}/quizzes/${this.quizId}/start_session/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        credentials: 'include'
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('‚ùå Session creation failed:', { status: response.status, error: errorText });
                        throw new Error(`Failed to create session: ${response.status}`);
                    }

                    const session = await response.json();
                    this.sessionId = session.id;
                    this.gameStatus = session.status;

                    console.log('‚úÖ Session created/retrieved:', session);
                    console.log('üéØ Using session ID:', this.sessionId);
                } catch (error) {
                    console.error('‚ùå Error creating session:', error);
                    throw error;
                }
            }

            async loadPlayers() {
                if (!this.sessionId) {
                    console.warn('‚ö†Ô∏è No session ID available for loading players');
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/sessions/${this.sessionId}/leaderboard/`, {
                        credentials: 'include'
                    });

                    if (!response.ok) {
                        console.warn(`‚ö†Ô∏è Leaderboard endpoint failed (${response.status}), trying session endpoint...`);

                        const sessionResponse = await fetch(`${API_BASE}/sessions/${this.sessionId}/`, {
                            credentials: 'include'
                        });

                        if (!sessionResponse.ok) {
                            throw new Error(`Both endpoints failed: ${sessionResponse.status}`);
                        }

                        const sessionData = await sessionResponse.json();
                        this.players = sessionData.players || [];
                    } else {
                        const data = await response.json();
                        this.players = data.leaderboard || [];
                    }

                    if (this.gameStatus === 'waiting') {
                        this.displayPlayers();
                    } else {
                        this.updateGameLeaderboard();
                    }

                } catch (error) {
                    console.error('‚ùå Error loading players:', error);
                }
            }

            displayPlayers() {
                const playerList = document.getElementById('player-list');
                const playerCount = document.getElementById('player-count');
                const statusText = document.getElementById('status-text');

                playerCount.textContent = this.players.length;

                if (this.players.length === 0) {
                    playerList.innerHTML = '<div style="text-align: center; color: #6b7280;">No players connected yet</div>';
                    statusText.textContent = 'Waiting for Players...';
                    return;
                }

                statusText.textContent = `${this.players.length} player${this.players.length !== 1 ? 's' : ''} ready to play!`;

                playerList.innerHTML = this.players.map(player => `
                    <div class="player-item">
                        <div class="player-avatar">${player.nickname.charAt(0).toUpperCase()}</div>
                        <div>${player.nickname}</div>
                    </div>
                `).join('');

                const startBtn = document.getElementById('start-game-btn');
                const buttonText = document.getElementById('buttonText');
                if (this.players.length > 0) {
                    startBtn.disabled = false;
                    buttonText.textContent = `Start Game (${this.players.length} players)`;
                } else {
                    startBtn.disabled = true;
                    buttonText.textContent = 'Start Game (Need at least 1 player)';
                }

                console.log('üë• Players displayed:', this.players.length);
            }

            startPlayerRefresh() {
                console.log('üîÑ Starting player refresh polling...');
                this.loadPlayers();
                this.refreshInterval = setInterval(() => {
                    this.loadPlayers();
                }, 3000);
            }

            // UPDATED: Enhanced game state monitoring with auto-advance detection
            startGameStateMonitoring() {
                console.log('üìä Starting enhanced game state monitoring...');

                this.gameStateInterval = setInterval(async () => {
                    try {
                        const response = await fetch(`${API_BASE}/sessions/${this.sessionId}/game_state/`, {
                            credentials: 'include'
                        });

                        if (response.ok) {
                            const gameState = await response.json();
                            this.updateHostInterface(gameState);

                            // NEW: Check for auto-advance
                            this.checkAutoAdvance(gameState);
                        }
                    } catch (error) {
                        console.error('‚ùå Game state monitoring error:', error);
                    }
                }, 1000); // Update every second for host
            }

            // NEW: Detect and handle auto-advance
            checkAutoAdvance(gameState) {
                const currentIndex = gameState.current_question_index || 0;

                // Check if question changed and it was auto-advanced
                if (currentIndex !== this.lastQuestionIndex && gameState.auto_advanced) {
                    console.log(`‚è∞ Auto-advance detected: Question ${this.lastQuestionIndex + 1} ‚Üí ${currentIndex + 1}`);

                    // Show auto-advance notification
                    this.showAutoAdvanceNotification();

                    // Update current question
                    this.currentQuestionIndex = currentIndex;
                    this.loadCurrentQuestion();
                }

                // Update last known question index
                this.lastQuestionIndex = currentIndex;

                // Check if game finished due to auto-advance
                if (gameState.status === 'finished' && gameState.final_scores) {
                    this.showGameCompleted(gameState.final_scores);
                }
            }

            // NEW: Show auto-advance notification
            showAutoAdvanceNotification() {
                const indicator = document.getElementById('auto-advance-indicator');
                indicator.style.display = 'block';

                // Show notification
                this.showNotification('Question auto-advanced due to time expiry', 'warning');

                // Hide indicator after animation
                setTimeout(() => {
                    indicator.style.display = 'none';
                }, 3000);
            }

            updateHostInterface(gameState) {
                // Update timer display
                const timeLeft = Math.ceil(gameState.time_left || 0);
                document.getElementById('question-timer').textContent = timeLeft;
                document.getElementById('time-remaining').textContent = `${timeLeft}s`;

                // Update timer color based on time left
                const timerElement = document.getElementById('question-timer');
                if (timeLeft <= 5) {
                    timerElement.classList.add('warning');
                } else {
                    timerElement.classList.remove('warning');
                }

                // Update responses count
                document.getElementById('responses-count').textContent =
                    `? / ${gameState.player_count} players responded`;

                // Update leaderboard
                if (gameState.players) {
                    this.updateGameLeaderboard(gameState.players);
                }
            }

            async startGame() {
                if (this.players.length === 0) {
                    this.showNotification('Cannot start game without players! Wait for at least one player to join.', 'error');
                    return;
                }

                try {
                    console.log('üöÄ Starting game for session:', this.sessionId);
                    this.setLoadingState(true, 'start');

                    if (!csrfToken) {
                        await this.fetchCSRFToken();
                    }

                    const response = await fetch(`${API_BASE}/sessions/${this.sessionId}/start_game/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        credentials: 'include'
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('‚ùå Game start failed:', { status: response.status, error: errorText });

                        if (response.status === 403) {
                            console.log('üîÑ 403 error, refreshing CSRF token and retrying...');
                            await this.fetchCSRFToken();

                            const retryResponse = await fetch(`${API_BASE}/sessions/${this.sessionId}/start_game/`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': csrfToken
                                },
                                credentials: 'include'
                            });

                            if (!retryResponse.ok) {
                                const retryErrorText = await retryResponse.text();
                                throw new Error(`Retry failed: ${retryResponse.status} - ${retryErrorText}`);
                            }

                            const retryData = await retryResponse.json();
                            console.log('‚úÖ Game started successfully on retry:', retryData);
                            this.gameStatus = 'active';
                            this.currentQuestionIndex = 0;
                            this.lastQuestionIndex = 0; // NEW: Initialize tracking
                            await this.switchToGameInterface();
                            return;
                        }

                        throw new Error(`Failed to start game: ${response.status} - ${errorText}`);
                    }

                    const data = await response.json();
                    console.log('‚úÖ Game started successfully:', data);

                    this.gameStatus = 'active';
                    this.currentQuestionIndex = 0;
                    this.lastQuestionIndex = 0; // NEW: Initialize tracking
                    await this.switchToGameInterface();

                } catch (error) {
                    console.error('‚ùå Error starting game:', error);
                    this.showNotification('Failed to start game: ' + error.message, 'error');
                } finally {
                    this.setLoadingState(false, 'start');
                }
            }

            async switchToGameInterface() {
                console.log('üéÆ Switching to game interface');

                if (this.refreshInterval) {
                    clearInterval(this.refreshInterval);
                }

                document.getElementById('waiting-interface').style.display = 'none';
                document.getElementById('game-controls').classList.add('active');

                await this.loadCurrentQuestion();
                this.startGameStateMonitoring(); // Start monitoring with auto-advance detection

                this.showNotification('Game started! Questions will auto-advance when time expires.', 'success');
            }

            async loadCurrentQuestion() {
                try {
                    const response = await fetch(`${API_BASE}/quizzes/${this.quizId}/`, {
                        credentials: 'include'
                    });

                    if (!response.ok) {
                        throw new Error(`Failed to load quiz: ${response.status}`);
                    }

                    const quiz = await response.json();
                    const questions = quiz.questions || [];

                    if (questions.length > this.currentQuestionIndex) {
                        this.currentQuestion = questions[this.currentQuestionIndex];
                        this.displayCurrentQuestion();
                    }
                } catch (error) {
                    console.error('‚ùå Error loading current question:', error);
                }
            }

            displayCurrentQuestion() {
                if (!this.currentQuestion) return;

                document.getElementById('question-number').textContent =
                    `Question ${this.currentQuestionIndex + 1} of ${this.totalQuestions}`;

                document.getElementById('current-question-text').textContent = this.currentQuestion.question_text;

                const answersContainer = document.getElementById('current-answer-options');
                const allAnswers = [this.currentQuestion.correct_answer, ...this.currentQuestion.wrong_answers];
                const labels = ['A', 'B', 'C', 'D'];

                answersContainer.innerHTML = allAnswers.map((answer, index) => `
                    <div class="answer-option ${answer === this.currentQuestion.correct_answer ? 'correct-answer' : ''}">
                        <div class="answer-label">${labels[index]}</div>
                        <div>${answer}</div>
                    </div>
                `).join('');
            }

            updateGameLeaderboard(players = null) {
                const leaderboardElement = document.getElementById('game-leaderboard');
                const playersToShow = players || this.players;

                if (leaderboardElement && playersToShow.length > 0) {
                    leaderboardElement.innerHTML = playersToShow.map((player, index) => `
                        <div class="leaderboard-item">
                            <span>#${index + 1} ${player.nickname}</span>
                            <span>${player.score || 0} pts</span>
                        </div>
                    `).join('');
                }
            }

            async nextQuestion() {
                try {
                    console.log('‚è≠Ô∏è Host manually requesting next question');

                    if (!csrfToken) {
                        await this.fetchCSRFToken();
                    }

                    const response = await fetch(`${API_BASE}/sessions/${this.sessionId}/next_question/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        credentials: 'include'
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Failed to get next question: ${response.status} - ${errorText}`);
                    }

                    const data = await response.json();
                    console.log('‚è≠Ô∏è Next question response:', data);

                    if (data.status === 'Quiz completed') {
                        this.showGameCompleted(data.final_scores || []);
                    } else {
                        this.currentQuestionIndex++;
                        this.lastQuestionIndex = this.currentQuestionIndex; // Update tracking
                        await this.loadCurrentQuestion();
                        console.log(`üìù Manually advanced to question ${this.currentQuestionIndex + 1}`);

                        // Show manual advance notification
                        this.showNotification(`Advanced to Question ${this.currentQuestionIndex + 1}`, 'info');
                    }

                } catch (error) {
                    console.error('‚ùå Error getting next question:', error);
                    this.showNotification('Failed to get next question: ' + error.message, 'error');
                }
            }

            showGameCompleted(finalScores) {
                if (this.gameStateInterval) {
                    clearInterval(this.gameStateInterval);
                }

                document.getElementById('game-controls').innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <h2 style="color: #16a34a; margin-bottom: 30px;">üéâ Quiz Completed!</h2>
                        <div class="mini-leaderboard">
                            <h4>Final Results</h4>
                            ${finalScores.map((player, index) => `
                                <div class="leaderboard-item">
                                    <span>#${index + 1} ${player.nickname}</span>
                                    <span>${player.score} pts</span>
                                </div>
                            `).join('')}
                        </div>
                        <button class="secondary-button" onclick="window.location.href='/dashboard/'" style="margin-top: 20px;">
                            Back to Dashboard
                        </button>
                    </div>
                `;
            }

            setLoadingState(isLoading, type) {
                if (type === 'start') {
                    const button = document.getElementById('start-game-btn');
                    const spinner = document.getElementById('loadingSpinner');
                    const text = document.getElementById('buttonText');

                    if (isLoading) {
                        button.disabled = true;
                        spinner.style.display = 'inline-block';
                        text.textContent = 'Starting Game...';
                    } else {
                        button.disabled = false;
                        spinner.style.display = 'none';
                        text.textContent = 'Start Game (Need at least 1 player)';
                    }
                }
            }

            showNotification(message, type) {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.className = `notification ${type}`;
                notification.style.display = 'block';

                console.log(`üì¢ Notification (${type}): ${message}`);

                if (type === 'success' || type === 'info' || type === 'warning') {
                    setTimeout(() => {
                        notification.style.display = 'none';
                    }, 5000);
                }
            }

            cleanup() {
                if (this.refreshInterval) {
                    clearInterval(this.refreshInterval);
                    console.log('üõë Player refresh polling stopped');
                }
                if (this.gameStateInterval) {
                    clearInterval(this.gameStateInterval);
                    console.log('üõë Game state monitoring stopped');
                }
            }
        }

        let gameManager;

        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üìÑ Page loaded, starting game manager...');
            gameManager = new GameHostManager();
        });

        window.addEventListener('beforeunload', () => {
            if (gameManager) {
                gameManager.cleanup();
            }
        });

        function refreshPlayers() {
            console.log('üîÑ Manual player refresh requested');
            if (gameManager) {
                gameManager.loadPlayers();
            }
        }

        function startGame() {
            console.log('üöÄ Start game button clicked');
            if (gameManager) {
                gameManager.startGame();
            }
        }

        function nextQuestion() {
            console.log('‚è≠Ô∏è Next question button clicked');
            if (gameManager) {
                gameManager.nextQuestion();
            }
        }

        function endGame() {
            if (confirm('Are you sure you want to end the game?')) {
                console.log('üõë End game requested');
                window.location.href = '/dashboard/';
            }
        }

        function backToDashboard() {
            localStorage.removeItem('playerData');
            localStorage.removeItem('sessionId');
            localStorage.removeItem('playerId');
            window.location.href = '/dashboard/';
        }
    </script>
</body>
</html>