<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Host Game - Quiz Platform</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: url("/static/images/dash_bg.png") center/cover no-repeat;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .container {
            background: white;
            border-radius: 24px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            padding: 50px;
            width: 100%;
            max-width: 950px;
            display: flex;
            gap: 50px;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        }

        .left-section {
            flex: 0 0 300px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quiz-illustration {
            width: 280px;
            height: 280px;
            background: url("/static/images/questionmarks.png") center/contain no-repeat;
            margin: 0 auto;
            opacity: 0.9;
        }

        .right-section {
            flex: 1;
            min-width: 0;
        }

        h1 {
            color: #1f2937;
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 30px;
            line-height: 1.2;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            background: #f8fafc;
            padding: 16px 20px;
            border-radius: 16px;
            border: 1px solid #e2e8f0;
        }

        .join-code-display, .player-count-display {
            font-size: 1rem;
            font-weight: 600;
            color: #374151;
        }

        .join-code-display span {
            color: #6366f1;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .player-count-display span {
            color: #16a34a;
            font-weight: 700;
        }

        .status-text {
            text-align: center;
            color: #6b7280;
            font-size: 1rem;
            margin-bottom: 16px;
            font-weight: 500;
        }

        .player-list {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            padding: 20px;
            min-height: 80px;
            max-height: 120px;
            overflow-y: auto;
            margin-bottom: 25px;
        }

        .player-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            font-size: 15px;
            color: #374151;
            font-weight: 500;
        }

        .player-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            margin-right: 12px;
        }

        .generate-button {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.25);
            width: 100%;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .generate-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(99, 102, 241, 0.35);
        }

        .generate-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .secondary-button {
            background: white;
            color: #6366f1;
            border: 2px solid #e2e8f0;
            padding: 14px 32px;
            border-radius: 16px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 8px;
        }

        .secondary-button:hover {
            background: #f8fafc;
            border-color: #6366f1;
            transform: translateY(-1px);
        }

        .notification {
            padding: 16px 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            font-weight: 500;
            display: none;
            font-size: 14px;
        }

        .notification.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .notification.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .notification.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .notification.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .loading-spinner {
            display: none;
            width: 18px;
            height: 18px;
            border: 2px solid transparent;
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Game Control Interface */
        .game-controls {
            display: none;
        }

        .game-controls.active {
            display: block;
        }

        .question-progress {
            background: #f8fafc;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid #e2e8f0;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .question-number {
            font-size: 1.1rem;
            font-weight: 600;
            color: #6366f1;
        }

        .question-timer {
            background: #fef3c7;
            color: #d97706;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1rem;
        }

        .question-timer.warning {
            background: #fecaca;
            color: #dc2626;
            animation: pulse 1s infinite;
        }

        .current-question {
            background: #e0e7ff;
            border-left: 4px solid #6366f1;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .question-text {
            font-size: 1.2rem;
            color: #1f2937;
            font-weight: 500;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .answer-options {
            display: grid;
            gap: 10px;
        }

        .answer-option {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .answer-label {
            background: #6366f1;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .correct-answer {
            border-color: #16a34a;
            background: #dcfce7;
        }

        .player-responses {
            background: #f9fafb;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
        }

        .response-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .responses-count {
            font-weight: 600;
            color: #374151;
        }

        .avg-time {
            color: #6b7280;
            font-size: 0.9rem;
        }

        .next-question-btn {
            background: #16a34a;
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 16px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .next-question-btn:hover {
            background: #15803d;
            transform: translateY(-1px);
        }

        .next-question-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .end-game-btn {
            background: #dc2626;
            color: white;
            border: none;
            padding: 12px 32px;
            border-radius: 16px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
        }

        .end-game-btn:hover {
            background: #b91c1c;
            transform: translateY(-1px);
        }

        .mini-leaderboard {
            background: #f8fafc;
            border-radius: 16px;
            padding: 20px;
            margin-top: 20px;
            margin-bottom: 30px;
            border: 1px solid #e2e8f0;
        }

        .mini-leaderboard h4 {
            margin: 0 0 15px 0;
            color: #374151;
            font-size: 1rem;
            font-weight: 600;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 0.9rem;
            border-bottom: 1px solid #e5e7eb;
            font-weight: 500;
        }

        .leaderboard-item:last-child {
            border-bottom: none;
        }

        .auto-advance-indicator {
            background: #fbbf24;
            color: #92400e;
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 15px;
            font-weight: 600;
            text-align: center;
            display: none;
            animation: fadeInOut 3s ease-in-out;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            10%, 90% { opacity: 1; }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                gap: 30px;
                padding: 30px 25px;
                max-width: 500px;
            }

            .left-section {
                flex: none;
            }

            .quiz-illustration {
                width: 200px;
                height: 200px;
            }

            .game-header {
                flex-direction: column;
                gap: 12px;
                text-align: center;
            }

            h1 {
                font-size: 1.8rem;
                text-align: center;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 15px;
            }

            .container {
                padding: 25px 20px;
            }

            .quiz-illustration {
                width: 160px;
                height: 160px;
            }

            h1 {
                font-size: 1.6rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="left-section">
            <div class="quiz-illustration"></div>
        </div>

        <div class="right-section">
            <h1 id="quiz-title">Quiz Title</h1>

            <div class="game-header">
                <div class="join-code-display">Join Code: <span id="join-code">ABC123</span></div>
                <div class="player-count-display">Players: <span id="player-count">0</span></div>
            </div>

            <div id="notification" class="notification"></div>

            <!-- WAITING ROOM INTERFACE -->
            <div id="waiting-interface">
                <div class="status-text" id="status-text">
                    Waiting for Players...
                </div>

                <div class="player-list" id="player-list">
                    <div style="text-align: center; color: #6b7280;">No players connected yet</div>
                </div>

                <div id="waiting-controls">
                    <button class="generate-button" id="start-game-btn" onclick="startGame()">
                        <div class="loading-spinner" id="loadingSpinner"></div>
                        <span id="buttonText">Start Game (Need at least 1 player)</span>
                    </button>
                    <button class="secondary-button" onclick="refreshPlayers()">
                        Refresh Players
                    </button>
                    <button class="secondary-button" onclick="backToDashboard()">
                        Back to Dashboard
                    </button>
                </div>
            </div>

            <!-- GAME CONTROL INTERFACE -->
            <div class="game-controls" id="game-controls">
                <!-- NEW: Auto-advance indicator -->
                <div class="auto-advance-indicator" id="auto-advance-indicator">
                    ‚è∞ Question auto-advanced due to time expiry
                </div>

                <div class="question-progress">
                    <div class="progress-header">
                        <div class="question-number" id="question-number">Question 1 of 5</div>
                        <div class="question-timer" id="question-timer">20</div>
                    </div>
                </div>

                <div class="current-question">
                    <div class="question-text" id="current-question-text">
                        Loading question...
                    </div>
                    <div class="answer-options" id="current-answer-options">
                        <!-- Answers will be displayed here -->
                    </div>
                </div>

                <div class="player-responses">
                    <div class="response-summary">
                        <div class="responses-count" id="responses-count">0 / 1 players responded</div>
                        <div class="avg-time" id="avg-time">Time left: <span id="time-remaining">20s</span></div>
                    </div>
                </div>

                <div class="mini-leaderboard">
                    <h4>Current Standings</h4>
                    <div id="game-leaderboard">
                        <!-- Leaderboard will be shown here -->
                    </div>
                </div>

                <button class="next-question-btn" id="next-question-btn" onclick="nextQuestion()">
                    <span id="next-btn-text">Next Question</span>
                </button>

                <button class="end-game-btn" onclick="endGame()">
                    End Game
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let csrfToken = '';

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        class GameHostManager {
            constructor() {
                this.quizId = null;
                this.sessionId = null;
                this.gameStatus = 'waiting';
                this.players = [];
                this.refreshInterval = null;
                this.gameStateInterval = null;
                this.currentQuestionIndex = 0;
                this.totalQuestions = 5;
                this.currentQuestion = null;
                this.lastQuestionIndex = -1; // NEW: Track question changes

                this.init();
            }

            async init() {
                try {
                    console.log('üéÆ Starting host game initialization...');
                    await this.fetchCSRFToken();
                    await this.loadQuizFromURL();
                    await this.loadQuizDetails();
                    await this.createOrGetSession();
                    this.startPlayerRefresh();
                    console.log('‚úÖ Host game initialization completed successfully');
                } catch (error) {
                    console.error('‚ùå Initialization error:', error);
                    this.showNotification('Failed to initialize game. Please try again.', 'error');
                }
            }

            async fetchCSRFToken() {
                try {
                    const response = await fetch(`${API_BASE}/auth/csrf/`, {
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        csrfToken = data.csrfToken;
                        console.log('‚úÖ CSRF token fetched from API successfully');
                    } else {
                        throw new Error('API endpoint failed');
                    }
                } catch (error) {
                    console.log('‚ö†Ô∏è API CSRF fetch failed, trying cookie fallback:', error);
                    csrfToken = getCookie('csrftoken');
                    if (csrfToken) {
                        console.log('‚úÖ CSRF token found in cookie');
                    } else {
                        console.error('‚ùå No CSRF token available');
                    }
                }
            }

            loadQuizFromURL() {
                const urlParams = new URLSearchParams(window.location.search);
                this.quizId = urlParams.get('quiz_id') || localStorage.getItem('currentQuizId');

                console.log('üìù Quiz ID from URL/localStorage:', this.quizId);

                if (!this.quizId) {
                    throw new Error('No quiz ID provided');
                }
            }

            async loadQuizDetails() {
                try {
                    console.log('üìö Loading quiz details for ID:', this.quizId);
                    const response = await fetch(`${API_BASE}/quizzes/${this.quizId}/`, {
                        credentials: 'include'
                    });

                    if (!response.ok) {
                        throw new Error(`Failed to load quiz: ${response.status}`);
                    }

                    const quiz = await response.json();
                    console.log('üìö Quiz details loaded:', quiz);

                    this.displayQuizInfo(quiz);
                    this.totalQuestions = quiz.questions ? quiz.questions.length : 5;
                } catch (error) {
                    console.error('‚ùå Error loading quiz:', error);
                    throw error;
                }
            }

            displayQuizInfo(quiz) {
                document.getElementById('quiz-title').textContent = quiz.title;
                document.getElementById('join-code').textContent = quiz.join_code;
                console.log('üè∑Ô∏è Quiz info displayed:', { title: quiz.title, joinCode: quiz.join_code });
            }

            async createOrGetSession() {
                try {
                    console.log('üéØ Creating/getting session for quiz:', this.quizId);

                    if (!csrfToken) {
                        await this.fetchCSRFToken();
                    }

                    const response = await fetch(`${API_BASE}/quizzes/${this.quizId}/start_session/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        credentials: 'include'
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('‚ùå Session creation failed:', { status: response.status, error: errorText });
                        throw new Error(`Failed to create session: ${response.status}`);
                    }

                    const session = await response.json();
                    this.sessionId = session.id;
                    this.gameStatus = session.status;

                    console.log('‚úÖ Session created/retrieved:', session);
                    console.log('üéØ Using session ID:', this.sessionId);
                } catch (error) {
                    console.error('‚ùå Error creating session:', error);
                    throw error;
                }
            }

            async loadPlayers() {
                if (!this.sessionId) {
                    console.warn('‚ö†Ô∏è No session ID available for loading players');
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/sessions/${this.sessionId}/leaderboard/`, {
                        credentials: 'include'
                    });

                    if (!response.ok) {
                        console.warn(`‚ö†Ô∏è Leaderboard endpoint failed (${response.status}), trying session endpoint...`);

                        const sessionResponse = await fetch(`${API_BASE}/sessions/${this.sessionId}/`, {
                            credentials: 'include'
                        });

                        if (!sessionResponse.ok) {
                            throw new Error(`Both endpoints failed: ${sessionResponse.status}`);
                        }

                        const sessionData = await sessionResponse.json();
                        this.players = sessionData.players || [];
                    } else {
                        const data = await response.json();
                        this.players = data.leaderboard || [];
                    }

                    if (this.gameStatus === 'waiting') {
                        this.displayPlayers();
                    } else {
                        this.updateGameLeaderboard();
                    }

                } catch (error) {
                    console.error('‚ùå Error loading players:', error);
                }
            }

            displayPlayers() {
                const playerList = document.getElementById('player-list');
                const playerCount = document.getElementById('player-count');
                const statusText = document.getElementById('status-text');

                playerCount.textContent = this.players.length;

                if (this.players.length === 0) {
                    playerList.innerHTML = '<div style="text-align: center; color: #6b7280;">No players connected yet</div>';
                    statusText.textContent = 'Waiting for Players...';
                    return;
                }

                statusText.textContent = `${this.players.length} player${this.players.length !== 1 ? 's' : ''} ready to play!`;

                playerList.innerHTML = this.players.map(player => `
                    <div class="player-item">
                        <div class="player-avatar">${player.nickname.charAt(0).toUpperCase()}</div>
                        <div>${player.nickname}</div>
                    </div>
                `).join('');

                const startBtn = document.getElementById('start-game-btn');
                const buttonText = document.getElementById('buttonText');
                if (this.players.length > 0) {
                    startBtn.disabled = false;
                    buttonText.textContent = `Start Game (${this.players.length} players)`;
                } else {
                    startBtn.disabled = true;
                    buttonText.textContent = 'Start Game (Need at least 1 player)';
                }

                console.log('üë• Players displayed:', this.players.length);
            }

            startPlayerRefresh() {
                console.log('üîÑ Starting player refresh polling...');
                this.loadPlayers();
                this.refreshInterval = setInterval(() => {
                    this.loadPlayers();
                }, 3000);
            }

            startGameStateMonitoring() {
                console.log('üìä Starting enhanced game state monitoring...');

                this.gameStateInterval = setInterval(async () => {
                    try {
                        const response = await fetch(`${API_BASE}/sessions/${this.sessionId}/game_state/`, {
                            credentials: 'include'
                        });

                        if (response.ok) {
                            const gameState = await response.json();
                            this.updateHostInterface(gameState);

                            // FIXED: Better auto-advance detection
                            this.checkForQuestionChanges(gameState);
                        }
                    } catch (error) {
                        console.error('‚ùå Game state monitoring error:', error);
                    }
                }, 1000); // Update every second for host
            }

            setSyncStatus(message, type) {
                console.log(`üì° Host Status: ${message} (${type})`);

                // Optional: Add a visual status indicator if you have one
                const statusElement = document.getElementById('host-status');
                if (statusElement) {
                    statusElement.textContent = message;
                    statusElement.className = `host-status ${type}`;
                }
            }

           checkForQuestionChanges(gameState) {
                const currentIndex = gameState.current_question_index || 0;
                const timeLeft = gameState.time_left || 0;
                const totalQuestions = gameState.total_questions || this.totalQuestions;

                console.log(`üîç Question check: Current=${currentIndex}, Total=${totalQuestions}, Status=${gameState.status}`);

                // FIXED: Check for game completion FIRST
                if (gameState.status === 'finished' || currentIndex >= totalQuestions) {
                    console.log('üèÅ Game completed - showing final results');

                    // Make sure we have final scores data
                    const finalScores = gameState.final_scores || gameState.players || [];
                    this.showGameCompleted(finalScores);
                    return;
                }

                // Check if question actually changed
                if (currentIndex !== this.currentQuestionIndex) {
                    console.log(`üìù Question change detected: ${this.currentQuestionIndex} ‚Üí ${currentIndex}`);

                    // Update current question index
                    this.currentQuestionIndex = currentIndex;

                    // Load the new question
                    this.loadCurrentQuestion();

                    // Show appropriate notification
                    if (timeLeft <= 0 || gameState.auto_advanced) {
                        console.log(`‚è∞ AUTO-ADVANCE: Question ${currentIndex + 1} loaded due to time expiry`);
                        this.showAutoAdvanceNotification();
                    } else {
                        console.log(`üë§ MANUAL ADVANCE: Question ${currentIndex + 1} loaded by host`);
                        this.showNotification(`Advanced to Question ${currentIndex + 1}`, 'info');
                    }
                }
            }

            // NEW: Detect and handle auto-advance
            checkAutoAdvance(gameState) {
                const currentIndex = gameState.current_question_index || 0;

                // Check if question changed and it was auto-advanced
                if (currentIndex !== this.lastQuestionIndex && gameState.auto_advanced) {
                    console.log(`‚è∞ Auto-advance detected: Question ${this.lastQuestionIndex + 1} ‚Üí ${currentIndex + 1}`);

                    // Show auto-advance notification
                    this.showAutoAdvanceNotification();

                    // Update current question
                    this.currentQuestionIndex = currentIndex;
                    this.loadCurrentQuestion();
                }

                // Update last known question index
                this.lastQuestionIndex = currentIndex;

                // Check if game finished due to auto-advance
                if (gameState.status === 'finished' && gameState.final_scores) {
                    this.showGameCompleted(gameState.final_scores);
                }
            }

            // NEW: Show auto-advance notification
            showAutoAdvanceNotification() {
                const indicator = document.getElementById('auto-advance-indicator');
                indicator.style.display = 'block';

                // Show notification
                this.showNotification('Question auto-advanced due to time expiry', 'warning');

                // Hide indicator after animation
                setTimeout(() => {
                    indicator.style.display = 'none';
                }, 3000);
            }

            updateHostInterface(gameState) {
                // Update timer display
                const timeLeft = Math.ceil(gameState.time_left || 0);
                const timerElement = document.getElementById('question-timer');
                const timeRemainingElement = document.getElementById('time-remaining');

                if (timerElement) {
                    timerElement.textContent = timeLeft;

                    if (timeLeft <= 5) {
                        timerElement.classList.add('warning');
                    } else {
                        timerElement.classList.remove('warning');
                    }
                }

                if (timeRemainingElement) {
                    timeRemainingElement.textContent = `${timeLeft}s`;
                }

                // FIXED: Now properly gets response count from backend
                const responsesElement = document.getElementById('responses-count');
                if (responsesElement) {
                    const playerCount = gameState.player_count || 0;
                    const responseCount = gameState.responses_received || 0;

                    responsesElement.textContent = `${responseCount} / ${playerCount} players responded`;

                    // Log for debugging
                    console.log(`üìä Response tracking: ${responseCount}/${playerCount} players responded`);
                }

                // Update leaderboard with current players
                if (gameState.players) {
                    this.updateGameLeaderboard(gameState.players);
                    this.players = gameState.players;
                }

                // Enable/disable next question button
                const nextBtn = document.getElementById('next-question-btn');
                const nextBtnText = document.getElementById('next-btn-text');

                if (nextBtn && nextBtnText) {
                    if (timeLeft <= 0) {
                        nextBtn.disabled = false;
                        nextBtnText.textContent = 'Time Up - Next Question';
                        nextBtn.style.background = '#f59e0b';
                    } else {
                        nextBtn.disabled = false;
                        nextBtnText.textContent = 'Next Question';
                        nextBtn.style.background = '#16a34a';
                    }
                }
            }


            async startGame() {
                if (this.players.length === 0) {
                    this.showNotification('Cannot start game without players! Wait for at least one player to join.', 'error');
                    return;
                }

                try {
                    console.log('üöÄ Starting game for session:', this.sessionId);
                    this.setLoadingState(true, 'start');

                    if (!csrfToken) {
                        await this.fetchCSRFToken();
                    }

                    const response = await fetch(`${API_BASE}/sessions/${this.sessionId}/start_game/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        credentials: 'include'
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('‚ùå Game start failed:', { status: response.status, error: errorText });

                        if (response.status === 403) {
                            console.log('üîÑ 403 error, refreshing CSRF token and retrying...');
                            await this.fetchCSRFToken();

                            const retryResponse = await fetch(`${API_BASE}/sessions/${this.sessionId}/start_game/`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': csrfToken
                                },
                                credentials: 'include'
                            });

                            if (!retryResponse.ok) {
                                const retryErrorText = await retryResponse.text();
                                throw new Error(`Retry failed: ${retryResponse.status} - ${retryErrorText}`);
                            }

                            const retryData = await retryResponse.json();
                            console.log('‚úÖ Game started successfully on retry:', retryData);
                            this.gameStatus = 'active';
                            this.currentQuestionIndex = 0;
                            this.lastQuestionIndex = 0; // NEW: Initialize tracking
                            await this.switchToGameInterface();
                            return;
                        }

                        throw new Error(`Failed to start game: ${response.status} - ${errorText}`);
                    }

                    const data = await response.json();
                    console.log('‚úÖ Game started successfully:', data);

                    this.gameStatus = 'active';
                    this.currentQuestionIndex = 0;
                    this.lastQuestionIndex = 0; // NEW: Initialize tracking
                    await this.switchToGameInterface();

                } catch (error) {
                    console.error('‚ùå Error starting game:', error);
                    this.showNotification('Failed to start game: ' + error.message, 'error');
                } finally {
                    this.setLoadingState(false, 'start');
                }
            }

            async switchToGameInterface() {
                console.log('üéÆ Switching to game interface');

                if (this.refreshInterval) {
                    clearInterval(this.refreshInterval);
                }

                document.getElementById('waiting-interface').style.display = 'none';
                document.getElementById('game-controls').classList.add('active');

                await this.loadCurrentQuestion();
                this.startGameStateMonitoring(); // Start monitoring with auto-advance detection

                this.showNotification('Game started! Questions will auto-advance when time expires.', 'success');
            }

            async loadCurrentQuestion() {
                try {
                    const response = await fetch(`${API_BASE}/quizzes/${this.quizId}/`, {
                        credentials: 'include'
                    });

                    if (!response.ok) {
                        throw new Error(`Failed to load quiz: ${response.status}`);
                    }

                    const quiz = await response.json();
                    const questions = quiz.questions || [];

                    if (questions.length > this.currentQuestionIndex) {
                        this.currentQuestion = questions[this.currentQuestionIndex];
                        this.displayCurrentQuestion();
                        console.log(`üìù Loaded question ${this.currentQuestionIndex + 1}: ${this.currentQuestion.question_text.substring(0, 50)}...`);
                    } else {
                        console.log('üèÅ No more questions available');
                    }
                } catch (error) {
                    console.error('‚ùå Error loading current question:', error);
                }
            }

            displayCurrentQuestion() {
                if (!this.currentQuestion) return;

                document.getElementById('question-number').textContent =
                    `Question ${this.currentQuestionIndex + 1} of ${this.totalQuestions}`;

                document.getElementById('current-question-text').textContent = this.currentQuestion.question_text;

                const answersContainer = document.getElementById('current-answer-options');
                const allAnswers = [this.currentQuestion.correct_answer, ...this.currentQuestion.wrong_answers];
                const labels = ['A', 'B', 'C', 'D'];

                answersContainer.innerHTML = allAnswers.map((answer, index) => `
                    <div class="answer-option ${answer === this.currentQuestion.correct_answer ? 'correct-answer' : ''}">
                        <div class="answer-label">${labels[index]}</div>
                        <div>${answer}</div>
                    </div>
                `).join('');
            }

            updateGameLeaderboard(players = null) {
                const leaderboardElement = document.getElementById('game-leaderboard');
                const playersToShow = players || this.players;

                if (leaderboardElement && playersToShow.length > 0) {
                    leaderboardElement.innerHTML = playersToShow.map((player, index) => `
                        <div class="leaderboard-item">
                            <span>#${index + 1} ${player.nickname}</span>
                            <span>${player.score || 0} pts</span>
                        </div>
                    `).join('');
                }
            }

            async nextQuestion() {
                try {
                    console.log('‚è≠Ô∏è Host manually requesting next question');

                    if (!csrfToken) {
                        await this.fetchCSRFToken();
                    }

                    const response = await fetch(`${API_BASE}/sessions/${this.sessionId}/next_question/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        credentials: 'include'
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Failed to get next question: ${response.status} - ${errorText}`);
                    }

                    const data = await response.json();
                    console.log('‚è≠Ô∏è Next question response:', data);

                    if (data.status === 'Quiz completed' || data.status === 'finished') {
                        this.showGameCompleted(data.final_scores || []);
                    } else {
                        // Don't manually increment here - let the monitoring detect the change
                        console.log(`üìù Next question request sent, waiting for game state update...`);
                        this.showNotification('Moving to next question...', 'info');
                    }

                } catch (error) {
                    console.error('‚ùå Error getting next question:', error);
                    this.showNotification('Failed to get next question: ' + error.message, 'error');
                }
            }

            showGameCompleted(finalScores) {
                console.log('üèÅ Host game completed - showing final screen');
                console.log('Final scores data:', finalScores);

                if (this.gameStateInterval) {
                    clearInterval(this.gameStateInterval);
                }

                // Stop all monitoring
                this.setSyncStatus('üèÅ Game Complete', 'success');

                // Ensure we have valid data
                const playersData = Array.isArray(finalScores) ? finalScores : [];
                const playerCount = playersData.length || this.players.length || 0;

                // Replace the entire game controls section with completion screen
                document.getElementById('game-controls').innerHTML = `
                    <div style="text-align: center; padding: 50px 20px;">
                        <div style="font-size: 4rem; margin-bottom: 20px;">üèÜ</div>
                        <h2 style="color: #16a34a; margin-bottom: 20px; font-size: 2rem;">Quiz Completed Successfully!</h2>
                        <p style="color: #6b7280; font-size: 1.1rem; margin-bottom: 30px;">
                            Great job hosting! All ${this.totalQuestions} questions have been completed.
                        </p>

                        <div class="mini-leaderboard" style="margin-bottom: 30px; max-width: 500px; margin-left: auto; margin-right: auto;">
                            <h4 style="font-size: 1.3rem; margin-bottom: 20px; color: #1f2937;">ü•á Final Results</h4>
                            ${playersData.length > 0 ? playersData.map((player, index) => {
                                let medal = '';
                                let bgColor = '';
                                if (index === 0) {
                                    medal = 'ü•á';
                                    bgColor = 'background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); color: #92400e;';
                                } else if (index === 1) {
                                    medal = 'ü•à';
                                    bgColor = 'background: linear-gradient(135deg, #c0c0c0 0%, #e5e7eb 100%); color: #374151;';
                                } else if (index === 2) {
                                    medal = 'ü•â';
                                    bgColor = 'background: linear-gradient(135deg, #cd7f32 0%, #d97706 100%); color: #fff;';
                                } else {
                                    bgColor = 'background: #f8fafc; color: #374151;';
                                }

                                return `
                                    <div class="leaderboard-item" style="padding: 12px 16px; border-radius: 8px; margin-bottom: 8px; ${bgColor}">
                                        <span style="font-weight: bold; font-size: 1.1rem;">
                                            ${medal} #${index + 1} ${player.nickname}
                                        </span>
                                        <span style="font-weight: bold; font-size: 1.1rem;">${player.score || 0} pts</span>
                                    </div>
                                `;
                            }).join('') : '<div style="color: #6b7280; padding: 20px;">No player data available</div>'}
                        </div>

                        <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 30px;">
                            <h4 style="color: #374151; margin-bottom: 10px;">üìä Game Statistics</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: center;">
                                <div>
                                    <div style="font-size: 1.5rem; font-weight: bold; color: #6366f1;">${playerCount}</div>
                                    <div style="color: #6b7280; font-size: 0.9rem;">Total Players</div>
                                </div>
                                <div>
                                    <div style="font-size: 1.5rem; font-weight: bold; color: #6366f1;">${this.totalQuestions}</div>
                                    <div style="color: #6b7280; font-size: 0.9rem;">Questions Completed</div>
                                </div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                            <button class="generate-button" onclick="window.location.href='/dashboard/'"
                                    style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); flex: 1; min-width: 200px; max-width: 250px;">
                                <span style="font-size: 1.1rem;">üìä Back to Dashboard</span>
                            </button>

                            <button class="secondary-button" onclick="hostAnotherQuiz()"
                                    style="flex: 1; min-width: 200px; max-width: 250px;">
                                <span style="font-size: 1.1rem;">üéÆ Host Another Quiz</span>
                            </button>
                        </div>

                        <div style="margin-top: 20px; padding: 15px; background: #e0e7ff; border-radius: 8px; border-left: 4px solid #6366f1;">
                            <p style="color: #1e40af; margin: 0; font-size: 0.95rem;">
                                üí° <strong>Tip:</strong> Players can now see their final results. You can start a new quiz or return to your dashboard.
                            </p>
                        </div>
                    </div>
                `;

                // Show completion notification
                this.showNotification('üéâ Quiz completed successfully! All players have finished.', 'success');

                // Log completion
                console.log('üèÅ Host game completed successfully');
            }

            setLoadingState(isLoading, type) {
                if (type === 'start') {
                    const button = document.getElementById('start-game-btn');
                    const spinner = document.getElementById('loadingSpinner');
                    const text = document.getElementById('buttonText');

                    if (isLoading) {
                        button.disabled = true;
                        spinner.style.display = 'inline-block';
                        text.textContent = 'Starting Game...';
                    } else {
                        button.disabled = false;
                        spinner.style.display = 'none';
                        text.textContent = 'Start Game (Need at least 1 player)';
                    }
                }
            }

            showNotification(message, type) {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.className = `notification ${type}`;
                notification.style.display = 'block';

                console.log(`üì¢ Notification (${type}): ${message}`);

                if (type === 'success' || type === 'info' || type === 'warning') {
                    setTimeout(() => {
                        notification.style.display = 'none';
                    }, 5000);
                }
            }

            cleanup() {
                if (this.refreshInterval) {
                    clearInterval(this.refreshInterval);
                    console.log('üõë Player refresh polling stopped');
                }
                if (this.gameStateInterval) {
                    clearInterval(this.gameStateInterval);
                    console.log('üõë Game state monitoring stopped');
                }
            }
        }

        let gameManager;

        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üìÑ Page loaded, starting game manager...');
            gameManager = new GameHostManager();
        });

        window.addEventListener('beforeunload', () => {
            if (gameManager) {
                gameManager.cleanup();
            }
        });

        function refreshPlayers() {
            console.log('üîÑ Manual player refresh requested');
            if (gameManager) {
                gameManager.loadPlayers();
            }
        }

        function startGame() {
            console.log('üöÄ Start game button clicked');
            if (gameManager) {
                gameManager.startGame();
            }
        }

        function nextQuestion() {
            console.log('‚è≠Ô∏è Next question button clicked');
            if (gameManager) {
                gameManager.nextQuestion();
            }
        }

        function endGame() {
            if (confirm('Are you sure you want to end the game?')) {
                console.log('üõë End game requested');
                window.location.href = '/dashboard/';
            }
        }

        function backToDashboard() {
            localStorage.removeItem('playerData');
            localStorage.removeItem('sessionId');
            localStorage.removeItem('playerId');
            window.location.href = '/dashboard/';
        }

        // Helper function for hosting another quiz
        function hostAnotherQuiz() {
            // Clear any stored game data
            localStorage.removeItem('currentQuizId');
            localStorage.removeItem('sessionId');
            localStorage.removeItem('currentQuizCode');

            // Show confirmation
            if (confirm('Start hosting a new quiz? This will take you back to create a new quiz.')) {
                console.log('üéÆ Redirecting to create new quiz');
                window.location.href = '/dashboard/';
            }
        }

        function setSyncStatus(message, type) {
            console.log(`üì° Host Status: ${message} (${type})`);

            // Optional: Add a visual status indicator if you have one
            const statusElement = document.getElementById('host-status');
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.className = `host-status ${type}`;
            }
        }

    </script>
</body>
</html>